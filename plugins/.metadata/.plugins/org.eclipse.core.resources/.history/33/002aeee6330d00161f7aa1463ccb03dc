package fr.inria.diverse.puzzle.metrics;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.EcoreFactory;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;

import fr.inria.diverse.puzzle.metrics.auxiliarMetrics.HCCalculator;
import fr.inria.diverse.puzzle.metrics.auxiliarMetrics.PairwiseCohesionMatrix;
import fr.inria.diverse.puzzle.metrics.vos.HCMatrix;

public class HCCalculatorTest {

	// -------------------------------------------------
	// Scenarios
	// -------------------------------------------------
	
	private HCCalculator hcCalculator;
	private EClass stateMachine;
	private EClass state;
	private EClass transition;
	private EClass statement;
	private EClass block;
	private EClass conditional;
	private EClass loop;
	private List<EClass> metaclasses;
	
	// -------------------------------------------------
	// Scenarios loading
	// -------------------------------------------------
	
	@Before
	public void loadScenario(){
		hcCalculator = new HCCalculator();
		
		// Creating EClasses
		stateMachine = EcoreFactory.eINSTANCE.createEClass();
		stateMachine.setName("StateMachine");
		
		state = EcoreFactory.eINSTANCE.createEClass();
		state.setName("State");
		
		transition = EcoreFactory.eINSTANCE.createEClass();
		transition.setName("Transition");
		
		statement = EcoreFactory.eINSTANCE.createEClass();
		statement.setName("Statement");
		statement.setAbstract(true);
		
		block = EcoreFactory.eINSTANCE.createEClass();
		block.setName("Block");
		
		conditional = EcoreFactory.eINSTANCE.createEClass();
		conditional.setName("Conditional");
		
		loop = EcoreFactory.eINSTANCE.createEClass();
		loop.setName("Loop");
		
		metaclasses = new ArrayList<EClass>();
		metaclasses.add(stateMachine);
		metaclasses.add(state);
		metaclasses.add(transition);
		metaclasses.add(statement);
		metaclasses.add(block);
		metaclasses.add(conditional);
		metaclasses.add(loop);
		
		// Creating EReferences
		EReference states = EcoreFactory.eINSTANCE.createEReference();
		states.setContainment(true);
		states.setName("states");
		states.setEType(state);
		stateMachine.getEStructuralFeatures().add(states);
		
		EReference stateMachineStates = EcoreFactory.eINSTANCE.createEReference();
		stateMachineStates.setContainment(false);
		stateMachineStates.setEType(stateMachine);
		stateMachineStates.setName("stateMachine");
		stateMachineStates.setEOpposite(states);
		state.getEStructuralFeatures().add(stateMachineStates);
		
		EReference transitions = EcoreFactory.eINSTANCE.createEReference();
		transitions.setContainment(true);
		transitions.setName("transitions");
		transitions.setEType(transition);
		stateMachine.getEStructuralFeatures().add(transitions);
		
		EReference stateMachineTransitions = EcoreFactory.eINSTANCE.createEReference();
		stateMachineTransitions.setContainment(false);
		stateMachineTransitions.setName("stateMachine");
		stateMachineTransitions.setEType(stateMachine);
		stateMachineTransitions.setEOpposite(transitions);
		transition.getEStructuralFeatures().add(stateMachineTransitions);
		
		EReference incoming = EcoreFactory.eINSTANCE.createEReference();
		incoming.setContainment(false);
		incoming.setName("incoming");
		incoming.setEType(transition);
		incoming.setLowerBound(0);
		incoming.setUpperBound(-1);
		state.getEStructuralFeatures().add(incoming);
		
		EReference target = EcoreFactory.eINSTANCE.createEReference();
		target.setContainment(false);
		target.setName("target");
		target.setEType(state);
		target.setLowerBound(1);
		target.setUpperBound(1);
		target.setEOpposite(incoming);
		transition.getEStructuralFeatures().add(target);
		
		EReference outgoing = EcoreFactory.eINSTANCE.createEReference();
		outgoing.setContainment(false);
		outgoing.setName("outgoing");
		outgoing.setEType(transition);
		outgoing.setLowerBound(0);
		outgoing.setUpperBound(-1);
		state.getEStructuralFeatures().add(outgoing);
		
		EReference source = EcoreFactory.eINSTANCE.createEReference();
		source.setContainment(false);
		source.setName("source");
		source.setEType(state);
		source.setLowerBound(1);
		source.setUpperBound(1);
		source.setEOpposite(outgoing);
		transition.getEStructuralFeatures().add(source);
		
		EReference doAction = EcoreFactory.eINSTANCE.createEReference();
		doAction.setContainment(true);
		doAction.setName("doAction");
		doAction.setEType(block);
		doAction.setLowerBound(0);
		doAction.setUpperBound(1);
		state.getEStructuralFeatures().add(doAction);
		
		EReference conditionalBody = EcoreFactory.eINSTANCE.createEReference();
		conditionalBody.setContainment(true);
		conditionalBody.setName("body");
		conditionalBody.setEType(block);
		conditionalBody.setLowerBound(0);
		conditionalBody.setUpperBound(1);
		conditional.getEStructuralFeatures().add(conditionalBody);
		
		EReference loopBody = EcoreFactory.eINSTANCE.createEReference();
		loopBody.setContainment(true);
		loopBody.setName("body");
		loopBody.setEType(block);
		loopBody.setLowerBound(0);
		loopBody.setUpperBound(1);
		loop.getEStructuralFeatures().add(loopBody);
		
		// Creating ESuperTypes
		block.getESuperTypes().add(statement);
		conditional.getESuperTypes().add(statement);
		loop.getESuperTypes().add(statement);
	}
	
	// -------------------------------------------------
	// Test cases
	// -------------------------------------------------
	
	@Test
	public void testMetricComputation(){
		double[][] matrix = PairwiseCohesionMatrix.computePairwiseCohesionMatrix(metaclasses);
		
		Assert.assertEquals(0.14, matrix[0][1], 0.01);
		Assert.assertEquals(0.14, matrix[0][2], 0.01);
		Assert.assertEquals(0, matrix[0][3], 0);
		Assert.assertEquals(0, matrix[0][4], 0);
		Assert.assertEquals(0, matrix[0][5], 0);
		Assert.assertEquals(0, matrix[0][5], 0);
		
		Assert.assertEquals(0.28, matrix[1][2], 0.01);
		Assert.assertEquals(0, matrix[1][3], 0);
		Assert.assertEquals(0.07, matrix[1][4], 0.01);
		Assert.assertEquals(0, matrix[1][5], 0);
		Assert.assertEquals(0, matrix[1][5], 0);
		
		Assert.assertEquals(0, matrix[2][3], 0);
		Assert.assertEquals(0, matrix[2][4], 0);
		Assert.assertEquals(0, matrix[2][5], 0);
		Assert.assertEquals(0, matrix[2][5], 0);
		
		Assert.assertEquals(0.07, matrix[3][4], 0.01);
		Assert.assertEquals(0.07, matrix[3][5], 0.01);
		Assert.assertEquals(0.07, matrix[3][5], 0.01);
		
		Assert.assertEquals(0.07, matrix[4][5], 0.01);
		Assert.assertEquals(0.07, matrix[4][5], 0.01);
		
		Assert.assertEquals(0, matrix[5][5], 0);
	}
	
	@Test
	public void testBuildInitialHCMatrixFromMetrixMatrix(){
		double[][] metricsMatrix = PairwiseCohesionMatrix.computePairwiseCohesionMatrix(metaclasses);
		HCMatrix initialMatrix = hcCalculator.buildInitialHCMatrixFromMetrixMatrix(metricsMatrix);
		
		// Row y = 0; x >= 1
		Assert.assertEquals("State", initialMatrix.getEntries().get(0).getX().geteClass().getName());
		Assert.assertEquals("StateMachine", initialMatrix.getEntries().get(0).getY().geteClass().getName());
		Assert.assertEquals(0.14, initialMatrix.getEntries().get(0).getValue(), 0.01);
		
		Assert.assertEquals("Transition", initialMatrix.getEntries().get(1).getX().geteClass().getName());
		Assert.assertEquals("StateMachine", initialMatrix.getEntries().get(1).getY().geteClass().getName());
		Assert.assertEquals(0.14, initialMatrix.getEntries().get(1).getValue(), 0.01);
		
		Assert.assertEquals("Statement", initialMatrix.getEntries().get(2).getX().geteClass().getName());
		Assert.assertEquals("StateMachine", initialMatrix.getEntries().get(2).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(2).getValue(), 0);
		
		Assert.assertEquals("Block", initialMatrix.getEntries().get(3).getX().geteClass().getName());
		Assert.assertEquals("StateMachine", initialMatrix.getEntries().get(3).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(3).getValue(), 0);
		
		Assert.assertEquals("Conditional", initialMatrix.getEntries().get(4).getX().geteClass().getName());
		Assert.assertEquals("StateMachine", initialMatrix.getEntries().get(4).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(4).getValue(), 0);
		
		Assert.assertEquals("Loop", initialMatrix.getEntries().get(5).getX().geteClass().getName());
		Assert.assertEquals("StateMachine", initialMatrix.getEntries().get(5).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(5).getValue(), 0);
	
		// Row y = 1; x >= 2
		Assert.assertEquals("Transition", initialMatrix.getEntries().get(6).getX().geteClass().getName());
		Assert.assertEquals("State", initialMatrix.getEntries().get(6).getY().geteClass().getName());
		Assert.assertEquals(0.28, initialMatrix.getEntries().get(6).getValue(), 0.01);
		
		Assert.assertEquals("Statement", initialMatrix.getEntries().get(7).getX().geteClass().getName());
		Assert.assertEquals("State", initialMatrix.getEntries().get(7).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(7).getValue(), 0);
		
		Assert.assertEquals("Block", initialMatrix.getEntries().get(8).getX().geteClass().getName());
		Assert.assertEquals("State", initialMatrix.getEntries().get(8).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(8).getValue(), 0);
		
		Assert.assertEquals("Conditional", initialMatrix.getEntries().get(9).getX().geteClass().getName());
		Assert.assertEquals("State", initialMatrix.getEntries().get(9).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(9).getValue(), 0);
		
		Assert.assertEquals("Loop", initialMatrix.getEntries().get(10).getX().geteClass().getName());
		Assert.assertEquals("State", initialMatrix.getEntries().get(10).getY().geteClass().getName());
		Assert.assertEquals(0, initialMatrix.getEntries().get(10).getValue(), 0);
	}
}
